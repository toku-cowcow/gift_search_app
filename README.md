# 🎁 UchiGift - 内祝いギフト検索アプリ

> **初学者にもわかる説明**: このプロジェクトは、結婚や出産などのお祝い事のお返し「内祝い」のギフトを簡単に検索できるWebアプリケーションです。現在は**Meilisearch検索エンジン + FastAPIバックエンド + Next.jsフロントエンド**を使用した本格的なWebアプリケーションとして完全動作しています。

## 🎯 このアプリケーションについて

UchiGift（ウチギフト）は、内祝いギフト専門の検索Webアプリケーションです。

### 📊 **現在の実装状況（2025年10月31日）**

**✅ 完全動作中の機能**:
- 🔍 **高性能検索機能**: 2,070件の商品データから瞬時検索
- 📊 **完璧なソート機能**: 価格順・レビュー順が検索クエリ時も正常動作  
- 🎯 **多彩なフィルタ機能**: 用途別・価格帯での絞り込み
- 🎨 **直感的なUI/UX**: レスポンシブ対応・ロゴクリックリセット

### 🎭 **対応シーン（用途別検索）**
- 👶 **出産内祝い**: 赤ちゃんが生まれたお祝いのお返し
- 💒 **結婚内祝い**: 結婚祝いをもらった時のお返し  
- 🕊️ **香典返し**: お葬式でお香典をもらった時のお返し
- 🏠 **新築内祝い**: 新居祝いをもらった時のお返し
- 💚 **快気祝い**: 病気や怪我から回復した時のお礼

### ✨ **主な機能の詳細説明**

#### 🔍 **検索機能（Meilisearch搭載）**
```
👤 ユーザーが「コーヒー」と検索
    ↓
🔍 Meilisearch が商品名・説明文を高速検索
    ↓
📊 関連商品225件を0.1秒で表示
    ↓
🎯 「コーヒーギフト」「ドリップコーヒー」「珈琲詰め合わせ」等がヒット
```

**🎯 検索の特徴**:
- ✅ **厳密部分一致**: 「コーヒー」で「コーヒーギフト」「ドリップコーヒー」がヒット
- ✅ **店舗名除外**: 「こーひー」で店舗名「こんぴらや」がヒットしない（精度向上）
- ✅ **タイポ無効**: 「あああああ」のような無意味な検索を排除
- ✅ **日本語対応**: ひらがな・カタカナ・漢字での検索が可能

#### 📊 **ソート機能（完全修正済み）**  
```
📊 検索結果: 「コーヒー」225件表示中
    ↓
👤 ユーザーが「価格安い順」を選択  
    ↓
⚡ 0.1秒で並び替え実行
    ↓
💰 432円 → 486円 → 540円... の順で正確に表示
```

**🎯 ソートの種類**:
- 💰 **価格安い順**: 432円 → 486円 → 540円... 
- 💰 **価格高い順**: 11,500円 → 8,640円 → 8,550円...
- ⭐ **レビュー件数順**: 6件 → 2件 → 1件... 
- ⭐ **レビュー評価順**: ★5.0 → ★5.0 → ★4.5...
- 📅 **新着順**: 最新更新順で表示

#### 🎯 **フィルタ機能（複数条件対応）**
```
👤 ユーザーの検索条件例:
   「出産内祝い」+ 「3,000円以下」+ 「タオル」
    ↓
🔍 システムが条件を組み合わせて検索  
    ↓
📊 該当商品のみを絞り込み表示
    ↓  
🎯 「今治タオル ギフトセット 2,800円（出産内祝い対応）」等が表示
```

**🎯 フィルタの種類**:
- 👶 **用途フィルタ**: 出産内祝い・結婚内祝い・香典返し・新築内祝い・快気祝い
- 💰 **価格帯フィルタ**: 〜3,000円・3,001〜5,000円・5,001〜10,000円・10,000円〜  
- 🔍 **キーワード検索**: 商品名・説明文での自由検索
- 🔗 **組み合わせ検索**: 複数条件での絞り込みが可能

#### 🎨 **ユーザーエクスペリエンス**
```
📱 スマホユーザーの場合:
   縦画面でも商品カードが見やすく1列表示
    ↓
💻 PCユーザーの場合:  
   横画面で商品カードが4列でたくさん表示
    ↓
🖱️ ロゴクリック時:
   UchiGiftロゴを押すと検索条件が全てリセットされてトップページに戻る
```

**🎯 UI/UXの特徴**:
- 📱 **レスポンシブ対応**: PC・スマホ・タブレットで最適表示  
- 🖱️ **ワンクリック操作**: フィルタはボタン1つで選択可能
- 🏠 **ロゴクリックリセット**: UchiGiftロゴ・SVG画像で検索条件初期化
- 🎨 **美しいデザイン**: Tailwind CSSによる洗練されたデザイン

## 🏗️ 技術構成（初学者向け詳細解説）

### 💻 **Webアプリケーションの仕組み（全体像）**

```
👤 ユーザー（あなた）
    ↓ ブラウザでアクセス（Chrome、Edge等）
🌐 フロントエンド（見た目・画面）← Next.js + React + TypeScript
    ↓ 商品データを要求（HTTP通信）
🔧 バックエンド（裏側の処理）← FastAPI + Python
    ↓ 商品を検索（検索クエリ）
🔍 検索エンジン（高速検索）← Meilisearch（Dockerで動作）
    ↓ データを保存・検索
💾 商品データベース ← 2,070件の商品データ（現在投入済み）
```

### 🔧 **各技術が何をしているか詳しく**

#### 🌐 **フロントエンド（Next.js + React + TypeScript）**
**役割**: ユーザーが実際に見て操作する画面部分

**例**: 商品の検索ボックス、商品カード、ページの見た目、ボタンなど

**技術の詳細**:
- **React**: 画面の部品（ボタン、カード、フォームなど）を作る技術
- **Next.js**: Reactを使いやすくするフレームワーク（高速化・SEO対応）
- **TypeScript**: JavaScriptに型チェック機能を加えた言語（バグ予防）
- **Tailwind CSS**: 美しいデザインを簡単に作るCSS framework

**実際の動作例**:
```
👤 ユーザーが「コーヒー」と検索ボックスに入力
    ↓
🌐 フロントエンドが入力を受け取り
    ↓  
📡 バックエンドに「コーヒー商品を探して」とリクエスト送信
    ↓
📊 受け取った商品データを美しいカード形式で画面表示
```

#### 🔧 **バックエンド（FastAPI + Python）**
**役割**: フロントエンドからの要求を受けて、データを処理して返す

**例**: 「コーヒーを検索して」という要求を受けて、商品データを探して返す

**技術の詳細**:
- **Python**: プログラミング言語（読みやすくて書きやすい）
- **FastAPI**: Pythonで高速なAPIを作るフレームワーク（自動ドキュメント生成）
- **Pydantic**: データ型チェック（間違ったデータの受け取りを防止）
- **uvicorn**: FastAPIサーバーを動かすWebサーバー

**実際の動作例**:
```
📡 http://localhost:8000/api/v1/search?q=コーヒー にアクセス
    ↓
🔧 FastAPIが「コーヒー」検索リクエストを受け取り
    ↓
🔍 Meilisearchに検索を依頼
    ↓
📊 商品リストをJSON形式で返却
    ↓
🌐 フロントエンドが受け取って画面表示
```

#### 🔍 **検索エンジン（Meilisearch + Docker）**
**役割**: たくさんの商品の中から、条件に合うものを高速で見つける

**例**: 「3000円以下のコーヒー」「出産内祝い用」などの複雑な条件で瞬時に検索

**技術の詳細**:
- **Meilisearch**: 超高速な全文検索エンジン（Googleのような検索機能）
- **Docker**: ソフトウェアを簡単に起動できるコンテナ技術
- **Docker Compose**: 複数のDockerコンテナを一括管理

**実際の動作例**:
```
🔍 検索条件「コーヒー + 3000円以下 + 出産内祝い」を受け取り
    ↓
⚡ 2,070件の商品データから0.1秒で検索実行
    ↓
🎯 条件に合う25件の商品をピックアップ
    ↓
📊 価格順・レビュー順などでソートして結果返却
```

#### 💾 **データソース（現在の状況）**
**現在**: 2,070件の実際の商品データがMeilisearchに投入済み
**将来**: 楽天市場APIから数万点の商品データを取得予定
**データの内容**: 商品名、価格、画像URL、販売店名、商品説明、レビュー数・評価など

### 🌊 **データの流れ（リアルタイム動作例）**

#### **例：「出産内祝い用のタオル、3000円以下」で検索する場合**

```
� 【ユーザー操作】
   1. トップページで「出産内祝い」ボタンをクリック
   2. 「〜3,000円」ボタンをクリック  
   3. 検索ボックスに「タオル」と入力
   4. 「検索」ボタンをクリック

🌐 【フロントエンド処理】
   1. Next.js が検索条件を収集
   2. API呼び出し関数（fetchSearch）を実行
   3. バックエンドへHTTPリクエスト送信
      → GET http://localhost:8000/api/v1/search?q=タオル&occasion=baby_return&price_max=3000

🔧 【バックエンド処理】  
   1. FastAPI が検索リクエストを受信
   2. パラメータを検証・変換（Pydanticスキーマ）
   3. MeilisearchServiceを呼び出し
   4. 検索オプションを構築
      → {query: "タオル", filters: ["occasion = 'baby_return'", "price <= 3000"]}

🔍 【Meilisearch処理】
   1. 「items」インデックスから検索実行
   2. 商品名・説明文で「タオル」を全文検索  
   3. occasion="baby_return" でフィルタリング
   4. price <= 3000 でさらに絞り込み
   5. 該当する8件の商品を発見（処理時間: 15ms）

📊 【結果返却】
   1. Meilisearch → FastAPI: 8件の商品データをJSON返却
   2. FastAPI → Next.js: API レスポンス（商品リスト）送信
   3. Next.js → ブラウザ: ProductCardコンポーネントで商品表示
   4. ユーザー画面に「今治タオルセット 2,800円」等が表示

⏱️ 【総処理時間】約0.3秒（検索〜画面表示まで）
```

### 🎯 **なぜこの技術構成を選んだか（技術選定理由）**

#### **🌐 Next.js + React を選んだ理由**
- ✅ **SEOに強い**: 検索エンジンに商品が表示されやすい
- ✅ **高速表示**: Server-Side Renderingで初回表示が早い
- ✅ **開発効率**: コンポーネント化で再利用しやすい
- ✅ **型安全性**: TypeScriptでバグを事前に防止

#### **🔧 FastAPI を選んだ理由**  
- ✅ **自動API仕様書**: http://localhost:8000/docs で仕様確認可能
- ✅ **高速処理**: Python製でありながら非常に高速
- ✅ **型チェック**: Pydanticで安全なAPI設計
- ✅ **非同期対応**: 大量リクエストでもパフォーマンス維持

#### **🔍 Meilisearch を選んだ理由**
- ✅ **超高速検索**: ElasticsearchやSolrより軽量で高速  
- ✅ **日本語対応**: ひらがな・カタカナ・漢字の検索が得意
- ✅ **簡単導入**: 設定がシンプルで学習コストが低い
- ✅ **リアルタイム**: データ更新が即座に検索結果に反映

#### **🐳 Docker を選んだ理由**
- ✅ **環境統一**: 開発者全員が同じ環境で動作可能
- ✅ **簡単起動**: `docker compose up -d` 一発でMeilisearch起動  
- ✅ **本番対応**: 本番環境でも同じ構成で動作
- ✅ **依存関係解決**: 複雑なソフトウェアインストールが不要

## 🌟 現在の実装状況（2025年10月31日）

### ✅ 完成済み機能

#### 🔍 **検索機能**
- **厳密部分一致**: 商品名・説明文での正確な検索
- **タイポ許容無効化**: 無意味な検索結果を排除
- **店舗名除外**: 検索対象から店舗名を除いて精度向上
- **データ件数**: 2,070件の商品データで検索可能

#### � **ソート機能（完全動作）**
- **価格ソート**: 安い順・高い順で正確な並び替え
- **レビューソート**: 件数順・評価順で正確な並び替え
- **新着順**: 更新日時による並び替え
- **検索クエリ対応**: 検索語句がある時でも正確にソート動作

#### 🎯 **フィルタ機能**
- **用途別**: 出産内祝い・結婚内祝い・香典返し・新築内祝い・快気祝い
- **価格帯**: 〜3,000円・3,001〜5,000円・5,001〜10,000円・10,000円〜
- **組み合わせ**: 複数条件での絞り込み検索

#### 🎨 **UI/UX機能**
- **ロゴクリックリセット**: UchiGiftロゴ・SVG画像クリックで検索条件初期化
- **レスポンシブ対応**: PC・スマホ・タブレットで最適表示
- **直感的操作**: ワンクリックでのフィルタ選択

## 📁 プロジェクト構造

```
🎁 gift_search_app/
├── 📄 README.md                           # プロジェクト説明書（このファイル）
├── 📄 complete_meilisearch_setup.py       # Meilisearch設定統合スクリプト  
├── 📁 venv/                              # Python仮想環境
│
├── 🏗️ infra/                             # インフラ設定
│   └── 📄 docker-compose.yml             # Meilisearch起動設定
│
├── 📊 scripts/                           # データ管理スクリプト
│   ├── 📄 index_meili.py                 # 商品データ投入スクリプト
│   └── 📁 data/
│       └── 📄 sample_items.json          # サンプル商品データ
│
├── 🔧 backend/                           # FastAPIバックエンド
│   ├── 📄 start_server.py                # サーバー起動スクリプト
│   ├── 📄 requirements.txt               # Python依存関係
│   └── 📁 app/                           # アプリケーション本体
│       ├── 📄 main.py                    # FastAPIメインアプリ
│       ├── 📁 api/v1/                    # APIエンドポイント
│       ├── � services/                  # ビジネスロジック
│       ├── 📁 schemas/                   # データ型定義
│       └──  core/                      # 設定管理
│
└── 🌐 frontend/                          # Next.jsフロントエンド
    ├── 📄 package.json                   # Node.js依存関係
    ├── 📄 next.config.ts                 # Next.js設定
    └──  src/
        ├── 📁 app/                       # ページコンポーネント
        ├── 📁 components/                # 再利用UI部品
        └── 📁 lib/                       # 共通ライブラリ
```

## � クイックスタート

## 🌟 現在の実装状況（2025年10月31日完了）

### ✅ **完全動作中の機能詳細**

#### 🔍 **検索機能（Meilisearch v1.10.3搭載）**

**🎯 検索精度の大幅改善完了**:
```
【改善前の問題】
❌ 「あああああ」検索 → 1,282件ヒット（無意味）
❌ 「こーひー」検索 → うどん店「こんぴらや」がヒット（店舗名誤マッチ）
❌ 検索+ソート → 並び順がバラバラ（ランキングルール問題）

【改善後の現在】  
✅ 「あああああ」検索 → 0件（無意味な検索を排除）
✅ 「こーひー」検索 → 0件（店舗名マッチなし）
✅ 「コーヒー」検索 → 225件（関連商品のみ的確にヒット）
✅ 検索+ソート → 完璧な並び順（ソート最優先設定）
```

**🔧 実装済みの検索最適化**:
- ✅ **searchableAttributes**: `["title", "description"]`（店舗名を除外）
- ✅ **typoTolerance**: `false`（あいまい検索を無効化）
- ✅ **rankingRules**: `["sort", "words", ...]`（ソートを最優先）
- ✅ **厳密部分一致**: 正確なキーワードのみ検索対象

#### 📊 **ソート機能（完全修正済み）**

**🎯 検索クエリ時のソート問題を完全解決**:
```
【実際のテスト結果】
🔍 「コーヒー」で検索 + 価格安い順:
   432円 → 486円 → 540円 → 540円 → 648円 → 698円...
   ✅ 完璧な価格順ソート

🔍 「コーヒー」で検索 + レビュー件数順:  
   6件 → 2件 → 1件 → 1件 → 0件 → 0件...
   ✅ 完璧なレビュー順ソート

🔍 空検索 + 価格安い順:
   291円 → 324円 → 330円 → 330円 → 350円...
   ✅ 全体でも完璧なソート
```

**🛠️ 技術的修正内容**:
- ✅ **Meilisearchランキングルール変更**: `sort`を最優先に配置
- ✅ **フロントエンドState管理改善**: URLパラメータから直接取得
- ✅ **バックエンドソート処理**: 配列形式でソートパラメータ送信

### 📋 事前準備チェック（最初に1回だけ）

まず以下のソフトウェアがインストールされているか確認してください：

#### 必須ソフトウェア

| ソフトウェア | 用途 | インストール確認方法 |
|------------|------|-------------------|
| **Docker Desktop** | 検索エンジン（Meilisearch）を動かすため | コマンドプロンプトで `docker --version` |
| **Python 3.8以上** | バックエンドAPI用 | コマンドプロンプトで `python --version` |
| **Node.js 18以上** | フロントエンド用 | コマンドプロンプトで `node --version` |
| **Git** | プロジェクトのダウンロード用 | コマンドプロンプトで `git --version` |

#### インストールされていない場合の対処法
```cmd
# 確認コマンド例
docker --version    # → Docker version 20.10.x が表示されるはず
python --version    # → Python 3.8.x 以上が表示されるはず  
node --version      # → v18.x.x 以上が表示されるはず
```

### ⚡ 10分間セットアップガイド

#### 🏁 ステップ0: プロジェクトの準備（1分）
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. 現在の場所を確認
dir
```
> **説明**: プロジェクトフォルダに確実に入っていることを確認します。`backend`, `frontend`, `infra` フォルダが見えるはずです。

#### 🔍 ステップ1: Meilisearch検索エンジン起動（1分）
```cmd
# 1. infraフォルダに移動
cd infra

# 2. Meilisearchをバックグラウンドで起動
docker compose up -d

# 3. 起動確認（30秒ほど待ってから）
docker ps
```
> **🔍 何をしている？**: 商品を高速検索するための検索エンジンを起動しています。`docker ps`で`meilisearch`が動いていることを確認してください。

**✅ 成功の確認方法**: ブラウザで http://localhost:7700 にアクセスしてMeilisearchの管理画面が表示される

#### 🐍 ステップ2: Python仮想環境の準備（3分）
```cmd
# 1. プロジェクトルートに戻る
cd ..

# 2. 仮想環境を作成（初回のみ・2分程度かかります）
python -m venv venv

# 3. 仮想環境を有効化（重要！）
venv\Scripts\activate

# 4. プロンプトが (venv) つきになることを確認
# (venv) C:\Users\...\gift_search_app> のような表示になる

# 5. 必要なライブラリをインストール（1分程度）
pip install -r backend\requirements.txt
```
> **🐍 何をしている？**: Pythonの仮想環境を作成して、プロジェクトに必要なライブラリを隔離してインストールしています。これにより他のPythonプロジェクトと干渉しません。

**⚠️ 重要な注意点**: 
- `(venv)`がプロンプトに表示されることを必ず確認してください
- 表示されない場合は `venv\Scripts\activate` を再実行

#### 📦 ステップ3: サンプルデータ投入（30秒）
```cmd
# 1. scriptsフォルダに移動
cd scripts

# 2. サンプルデータをMeilisearchに投入
python index_meili.py

# 3. プロジェクトルートに戻る
cd ..
```
> **📦 何をしている？**: 2,070件の商品データをMeilisearchに登録しています。これで本格的な検索テストができるようになります。

**✅ 成功の確認方法**: 
```
Successfully indexed 2070 items to Meilisearch
```
のようなメッセージが表示される

#### 🔧 ステップ4: バックエンド起動（新しいコマンドプロンプト）
**重要**: 新しいコマンドプロンプトを開いてください
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. 仮想環境を有効化
venv\Scripts\activate

# 3. backendフォルダに移動
cd backend

# 4. APIサーバーを起動
python start_server.py
```
> **🔧 何をしている？**: フロントエンドからの要求を処理するAPIサーバーを起動しています。商品検索やデータ取得を担当します。

**✅ 成功の確認方法**: 
```
INFO:     Uvicorn running on http://127.0.0.1:8000
```
のようなメッセージが表示され、ブラウザで http://localhost:8000/docs にアクセスするとSwagger UIが表示される

#### 🌐 ステップ5: フロントエンド起動（さらに新しいコマンドプロンプト）
**重要**: また新しいコマンドプロンプトを開いてください（合計3個目）
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. frontendフォルダに移動
cd frontend

# 3. Node.jsの依存関係をインストール（初回のみ・2分程度）
npm install

# 4. 開発サーバーを起動
npm run dev
```
> **🌐 何をしている？**: ユーザーが見る画面（Webサイト）を起動しています。React + Next.jsで作られた美しいUIが表示されます。

**✅ 成功の確認方法**: 
```
▲ Next.js 15.x.x
- Local:        http://localhost:3000
```
のようなメッセージが表示される

### 🎯 最終確認（1分）

すべてが正常に起動すると、以下3つのサービスが同時に動作します：

| サービス | URL | 説明 | 確認方法 |
|---------|-----|------|----------|
| **🌐 メインアプリ** | http://localhost:3000 | ユーザーが使う画面 | 美しいトップページが表示される |
| **🔧 API仕様書** | http://localhost:8000/docs | バックエンドAPI | Swagger UIでAPI一覧が見える |
| **🔍 検索エンジン** | http://localhost:7700 | Meilisearch管理画面 | 検索エンジンの管理画面 |

#### 🎮 動作テスト手順
1. http://localhost:3000 にアクセス
2. 「出産内祝い」ボタンをクリック
3. 商品が表示されることを確認
4. 検索ボックスに「タオル」と入力して検索
5. タオル商品がフィルターされることを確認
6. 並び順を「価格安い順」に変更して正しくソートされることを確認

**🎉 おめでとうございます！** すべて成功すれば、UchiGiftアプリが完全に動作しています！

### 🚀 将来の拡張されたデータフロー（楽天API + 複数EC + 大量データ対応）

```
1️⃣ 👤 ユーザー（あなた）
   └── 💻 「出産内祝い タオル 3000円以下」で検索

2️⃣ 🌐 フロントエンド（Next.js - 同じ構造を維持）
   ├── 📄 page.tsx → ProductGrid.tsx（変更なし）
   ├── 📡 /lib/api/search.ts → 同じAPIエンドポイントを呼び出し（変更なし）
   └── 🎯 リクエスト先: 同じ http://localhost:8000/api/v1/search

3️⃣ 🔧 バックエンド（FastAPI - プロバイダーパターンで拡張）
   ├── 📄 main.py: 同じエンドポイント（変更なし）
   ├── 🌐 api/v1/items.py: 同じ処理ロジック（変更なし）
   ├── 🔀 services/data_aggregator.py: **新規追加** - 複数データソース統合
   ├── 🛒 services/rakuten_provider.py: 楽天市場API連携
   ├── 🛍️ services/amazon_provider.py: **新規追加** - Amazon Product API
   ├── 🛒 services/yahoo_provider.py: **新規追加** - Yahoo!ショッピングAPI
   └── 🔍 services/meili_provider.py: 統合データの高速検索

4️⃣ 💾 データベース層（新規追加）
   ├── 🗄️ PostgreSQL: 商品マスタ・メタデータ・ユーザー履歴
   ├── 📊 Redis: 検索結果キャッシュ・セッション管理
   └── 🔍 Meilisearch: 全文検索インデックス（数十万件対応）

5️⃣ 📡 外部API連携（新規追加）
   ├── 🛒 楽天市場API: リアルタイム商品データ・在庫情報
   ├── 🛍️ Amazon Product API: 商品データ・レビュー情報  
   ├── 🛒 Yahoo!ショッピングAPI: 商品データ・価格情報
   └── 🔄 定期データ同期: GitHub Actions で1日1回自動更新

6️⃣ ⚡ 高速化・スケーラビリティ対策
   ├── 🚀 CDN: 商品画像の配信高速化
   ├── 📊 ロードバランサー: 複数サーバーへのリクエスト分散
   ├── 💾 キャッシュ戦略: 人気商品は Redis でメモリキャッシュ
   └── 📈 監視・アラート: システム負荷とAPI応答時間を監視

7️⃣ 🎨 フロントエンド（機能拡張、でも基本は変更なし）
   ├── 🧩 ProductCard.tsx: 複数ECサイトの価格比較表示
   ├── ⭐ レビュー統合: Amazon・楽天の評価を統合表示  
   ├── 📊 トレンド表示: 人気商品・急上昇商品を表示
   └── 🤖 AIレコメンド: 過去の検索履歴からおすすめ商品を提案
```

### 🔄 データソースの切り替え仕組み（現在と将来の比較）

#### 📍 現在の動作（2025年10月29日 確認済み）

**✅ 実際の動作確認結果**:
```
👤 ユーザー操作 
    ↓
🌐 フロントエンド (page.tsx → ProductGrid.tsx)
    ↓
📡 /lib/api/search.ts → fetchSearch() 関数
    ↓ 
🔗 HTTP GET http://localhost:8000/api/v1/search
    ↓
🔧 バックエンド FastAPI (api/v1/items.py)
    ↓
🔨 services/meili_provider.py → Meilisearchクライアント
    ↓
🔍 Meilisearch検索エンジン (localhost:7700)
    ↓
📦 インデックス「items」(12個のサンプルデータ)
    ↓
📊 JSON結果をレスポンス → フロントエンド表示
```

**🎯 重要発見**: 
- ❌ **誤解していた内容**: 「ダミーデータを使用、バックエンドは未接続」  
- ✅ **実際の状況**: **フル機能でバックエンドAPIを使用中！**
- ✅ **現在のデータ**: Meilisearchに12個のサンプル商品を投入済み
- ✅ **検索機能**: 全文検索・価格フィルタ・用途フィルタがすべて動作中

#### 🚀 将来の大容量データ対応（設計完了・実装待ち）

```
👤 ユーザー操作 (変更なし)
    ↓
🌐 フロントエンド (変更なし - 同じAPI呼び出し)
    ↓
📡 /lib/api/search.ts (変更なし - 同じエンドポイント)
    ↓ 
🔧 バックエンド FastAPI (同じエンドポイント)
    ↓
🔀 【新規】services/data_aggregator.py (複数データソース統合)
    ↓
┌─────────────────┬─────────────────┬─────────────────┐
│ 🛒 楽天API      │ 🛍️ Amazon API   │ 🛒 Yahoo API    │
│ (数万点)        │ (数万点)        │ (数万点)        │
└─────────────────┴─────────────────┴─────────────────┘
    ↓
💾 【新規】データベース統合
├── 🗄️ PostgreSQL: 商品マスタ・履歴・ユーザー情報
├── 📊 Redis: 高速キャッシュ・セッション管理  
└── 🔍 Meilisearch: 数十万件の全文検索インデックス
    ↓
📊 統合された検索結果 → 同じレスポンス形式 → フロントエンド表示(変更なし)
```

#### � データソース切り替えの仕組み（プロバイダーパターン）

現在の `services/meili_provider.py` をベースに、プロバイダーを増やすだけで拡張可能：

```python
# 現在（実装済み・稼働中）
class MeiliSearchProvider:
    def search(self, query) -> List[GiftItem]:
        # Meilisearchから12個のサンプルデータを検索
        
# 将来（設計済み・実装待ち）  
class DataAggregator:
    def __init__(self):
        self.providers = [
            MeiliSearchProvider(),      # 現在の検索（既存データ保持）
            RakutenAPIProvider(),       # 楽天市場API
            AmazonAPIProvider(),        # Amazon Product API  
            YahooShoppingProvider()     # Yahoo!ショッピングAPI
        ]
    
    def search(self, query) -> List[GiftItem]:
        # 複数プロバイダーから並行取得 → 統合 → 重複排除 → ソート
```

**🎯 切り替えの利点**:
- ✅ **フロントエンドは無変更**: 同じAPIを呼び出すだけ
- ✅ **段階的移行可能**: プロバイダーを1つずつ追加
- ✅ **障害対応**: 1つのAPIが落ちても他で継続
- ✅ **A/Bテスト**: データソース別で結果を比較可能

### 🎮 具体的な操作例

#### 例1: 出産内祝いでタオルを探す場合

1. **ユーザー操作**: 
   - トップページで「出産内祝い」をクリック
   - 価格帯「〜3,000円」をクリック  
   - 検索ボックスに「タオル」と入力

2. **システム処理**:
   ```javascript
   // フロントエンドが作る検索条件
   {
     occasion: "baby_return",
     price_max: 3000,
     q: "タオル"
   }
   ```

3. **結果表示**:
   - 条件に合うタオル商品がカード形式で表示
   - 各カードに画像、商品名、価格、販売店を表示
   - 「今治タオル ギフトセット 2,800円」など

#### 例2: 商品詳細を見る場合

1. **ユーザー操作**: 商品カードをクリック
2. **システム処理**: 商品IDで詳細データを取得
3. **結果表示**: 詳細ページで商品説明、レビュー、購入リンクを表示

### 💡 初学者向けポイント

- **なぜMeilisearchを使う？**: 数万点の商品から瞬時に検索するため
- **なぜNext.jsを使う？**: SEOに強く、高速なWebアプリが作れるため
- **なぜFastAPIを使う？**: Python書きやすく、API仕様書が自動生成されるため
- **なぜモック（ダミー）から始める？**: 複雑なAPI連携より、まず動くものを作るため

## 🚀 初回セットアップ手順（Windows版・超詳細ガイド）

> **初学者への約束**: この手順を順番に実行すれば、**約10分でアプリが起動**します。各手順で何をしているかも詳しく説明するので、安心して進めてください。

### 📋 事前準備チェック（最初に1回だけ）

まず以下のソフトウェアがインストールされているか確認してください：

#### 必須ソフトウェア

| ソフトウェア | 用途 | インストール確認方法 |
|------------|------|-------------------|
| **Docker Desktop** | 検索エンジン（Meilisearch）を動かすため | コマンドプロンプトで `docker --version` |
| **Python 3.8以上** | バックエンドAPI用 | コマンドプロンプトで `python --version` |
| **Node.js 18以上** | フロントエンド用 | コマンドプロンプトで `node --version` |
| **Git** | プロジェクトのダウンロード用 | コマンドプロンプトで `git --version` |

#### インストールされていない場合の対処法
```cmd
# 確認コマンド例
docker --version    # → Docker version 20.10.x が表示されるはず
python --version    # → Python 3.8.x 以上が表示されるはず  
node --version      # → v18.x.x 以上が表示されるはず
```

### ⚡ 10分間セットアップガイド

#### 🏁 ステップ0: プロジェクトの準備（1分）
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. 現在の場所を確認
dir
```
> **説明**: プロジェクトフォルダに確実に入っていることを確認します。`backend`, `frontend`, `infra` フォルダが見えるはずです。

#### 🔍 ステップ1: Meilisearch検索エンジン起動（1分）
```cmd
# 1. infraフォルダに移動
cd infra

# 2. Meilisearchをバックグラウンドで起動
docker compose up -d

# 3. 起動確認（30秒ほど待ってから）
docker ps
```
> **🔍 何をしている？**: 商品を高速検索するための検索エンジンを起動しています。`docker ps`で`meilisearch`が動いていることを確認してください。

**✅ 成功の確認方法**: ブラウザで http://localhost:7700 にアクセスしてMeilisearchの管理画面が表示される

#### 🐍 ステップ2: Python仮想環境の準備（3分）
```cmd
# 1. プロジェクトルートに戻る
cd ..

# 2. 仮想環境を作成（初回のみ・2分程度かかります）
python -m venv venv

# 3. 仮想環境を有効化（重要！）
venv\Scripts\activate

# 4. プロンプトが (venv) つきになることを確認
# (venv) C:\Users\...\gift_search_app> のような表示になる

# 5. 必要なライブラリをインストール（1分程度）
pip install -r backend\requirements.txt
```
> **🐍 何をしている？**: Pythonの仮想環境を作成して、プロジェクトに必要なライブラリを隔離してインストールしています。これにより他のPythonプロジェクトと干渉しません。

**⚠️ 重要な注意点**: 
- `(venv)`がプロンプトに表示されることを必ず確認してください
- 表示されない場合は `venv\Scripts\activate` を再実行

#### 📦 ステップ3: サンプルデータ投入（30秒）
```cmd
# 1. scriptsフォルダに移動
cd scripts

# 2. サンプルデータをMeilisearchに投入
python index_meili.py

# 3. プロジェクトルートに戻る
cd ..
```
> **📦 何をしている？**: 12個のサンプル商品（タオル、お茶、お菓子など）をMeilisearchに登録しています。これで検索テストができるようになります。

**✅ 成功の確認方法**: 
```
Successfully indexed 12 items to Meilisearch
```
のようなメッセージが表示される

#### 🔧 ステップ4: バックエンド起動（新しいコマンドプロンプト）
**重要**: 新しいコマンドプロンプトを開いてください
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. 仮想環境を有効化
venv\Scripts\activate

# 3. backendフォルダに移動
cd backend

# 4. APIサーバーを起動
python start_server.py
```
> **🔧 何をしている？**: フロントエンドからの要求を処理するAPIサーバーを起動しています。商品検索やデータ取得を担当します。

**✅ 成功の確認方法**: 
```
INFO:     Uvicorn running on http://127.0.0.1:8000
```
のようなメッセージが表示され、ブラウザで http://localhost:8000/docs にアクセスするとSwagger UIが表示される

#### 🌐 ステップ5: フロントエンド起動（さらに新しいコマンドプロンプト）
**重要**: また新しいコマンドプロンプトを開いてください（合計3個目）
```cmd
# 1. プロジェクトフォルダに移動
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app

# 2. frontendフォルダに移動
cd frontend

# 3. Node.jsの依存関係をインストール（初回のみ・2分程度）
npm install

# 4. 開発サーバーを起動
npm run dev
```
> **🌐 何をしている？**: ユーザーが見る画面（Webサイト）を起動しています。React + Next.jsで作られた美しいUIが表示されます。

**✅ 成功の確認方法**: 
```
▲ Next.js 15.x.x
- Local:        http://localhost:3000
```
のようなメッセージが表示される

### 🎯 最終確認（1分）

すべてが正常に起動すると、以下3つのサービスが同時に動作します：

| サービス | URL | 説明 | 確認方法 |
|---------|-----|------|----------|
| **🌐 メインアプリ** | http://localhost:3000 | ユーザーが使う画面 | 美しいトップページが表示される |
| **🔧 API仕様書** | http://localhost:8000/docs | バックエンドAPI | Swagger UIでAPI一覧が見える |
| **🔍 検索エンジン** | http://localhost:7700 | Meilisearch管理画面 | 検索エンジンの管理画面 |

#### 🎮 動作テスト手順
1. http://localhost:3000 にアクセス
2. 「出産内祝い」ボタンをクリック
3. 商品が表示されることを確認
4. 検索ボックスに「タオル」と入力して検索
5. タオル商品がフィルターされることを確認

**🎉 おめでとうございます！** すべて成功すれば、UchiGiftアプリが完全に動作しています！

### 🎯 動作確認

すべてが正常に起動すると、以下のURLでアクセスできます：

- **メインアプリ**: http://localhost:3000
- **API仕様書**: http://localhost:8000/docs  
- **Meilisearch管理画面**: http://localhost:7700

### 🔄 2回目以降の起動手順（超簡単版）

一度セットアップが完了すれば、次回からは**3つのコマンドプロンプト**で実行するだけです：

#### 📝 簡単起動チェックリスト
- [ ] **コマンドプロンプト1**: 検索エンジン起動
- [ ] **コマンドプロンプト2**: バックエンド起動  
- [ ] **コマンドプロンプト3**: フロントエンド起動

```cmd
# 🔍 ターミナル1: Meilisearch検索エンジン（10秒）
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app\infra
docker compose up -d

# 🔧 ターミナル2: バックエンドAPI（30秒）
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app\backend
..\venv\Scripts\activate
python start_server.py

# 🌐 ターミナル3: フロントエンド画面（30秒）  
cd c:\Users\tokuu\Documents\Python_development\No1_gift_search_app\gift_search_app\frontend
npm run dev
```

> **⏱️ 所要時間**: 合計約1分で全サービスが起動完了

#### 🎯 起動順序の重要なポイント
1. **Meilisearch → バックエンド → フロントエンド** の順で起動してください
2. 各サービスの起動完了を待ってから次に進んでください
3. すべて起動したら http://localhost:3000 でアプリを確認## 🧪 動作テスト項目（初学者向け詳細チェックリスト）

> **テストの目的**: アプリが正常に動作しているかを段階的に確認します。問題があれば早期に発見できます。

以下の機能が正常に動作することを確認してください：

### ✅ メインページテスト（http://localhost:3000）

#### 基本表示テスト
- [ ] **ページ読み込み**: 白い背景に美しいレイアウトが表示される
- [ ] **ヘッダー**: 「UchiGift」ロゴとナビゲーションが上部に表示
- [ ] **メインタイトル**: 「内祝いギフトを見つけよう」などのキャッチコピー
- [ ] **カテゴリーボタン**: 「出産内祝い」「結婚内祝い」「香典返し」ボタンが表示

#### インタラクション（操作）テスト  
- [ ] **カテゴリー選択**: 「出産内祝い」をクリックして色が変わる
- [ ] **価格帯選択**: 「〜3,000円」「〜5,000円」等のボタンがクリック可能
- [ ] **検索ボックス**: 「タオル」と入力して検索ボタンを押せる（**注意**: 現在はフロントエンド内のダミーデータをフィルタリングのみ。バックエンドAPI呼び出しなし）
- [ ] **商品表示**: カテゴリ・価格選択で商品カードが表示される

#### レスポンシブテスト
- [ ] **PC表示**: ブラウザ幅を広げても崩れない
- [ ] **スマホ表示**: ブラウザ幅を狭めてもボタンが使える（F12で確認）

### ✅ 検索ページテスト（http://localhost:3000/search）

#### 商品表示テスト
- [ ] **商品数確認**: 12個のサンプル商品がカード形式で表示される
- [ ] **商品カード内容**: 各カードに商品画像・名前・価格・販売店が表示
- [ ] **レイアウト**: PCでは4列、スマホでは1列で表示（レスポンシブ）

#### フィルター・ソート機能テスト
- [ ] **ソート機能**: 「価格の安い順」「価格の高い順」「新着順」を切り替え可能
- [ ] **価格順テスト**: 価格順でソートすると実際に価格順に並び替わる
- [ ] **検索機能**: 検索ボックスに「タオル」と入力すると該当商品のみ表示

#### 商品カードテスト  
- [ ] **画像表示**: 各商品の画像が正しく読み込まれる
- [ ] **商品名**: 「今治タオル ギフトセット」等の商品名が表示
- [ ] **価格表示**: 「¥2,800」等の価格が正しく表示  
- [ ] **販売店**: 「楽天市場 ○○店」等の店舗名が表示

### ✅ バックエンドAPIテスト（http://localhost:8000/docs）

#### Swagger UI確認テスト
- [ ] **API仕様書表示**: Swagger UIで美しいAPI仕様書が表示される
- [ ] **エンドポイント一覧**: `/health`, `/api/v1/search`, `/api/v1/stats/search` が表示
- [ ] **スキーマ確認**: 各APIの入力・出力形式が詳細に記載

#### 個別APIテスト（Swagger UIの「Try it out」で実行）
- [ ] **ヘルスチェック**: `GET /health` → `{"status": "ok"}` が返される
- [ ] **商品検索**: `GET /api/v1/search?q=タオル` → タオル商品リストが返される  
- [ ] **統計情報**: `GET /api/v1/stats/search` → 検索統計データが返される
- [ ] **全商品取得**: `GET /api/v1/search` → 12個の商品すべてが返される

#### レスポンス内容確認
- [ ] **JSON形式**: すべてのレスポンスがJSON形式で返される
- [ ] **日本語対応**: 商品名や説明の日本語が文字化けしない
- [ ] **エラーハンドリング**: 存在しないAPIにアクセスすると適切なエラーが返される

### ✅ Meilisearch検索エンジンテスト（http://localhost:7700）

#### 管理画面アクセステスト
- [ ] **管理画面表示**: Meilisearchの管理画面（ダッシュボード）が表示される
- [ ] **インデックス一覧**: 「items」インデックスが存在することを確認
- [ ] **データ確認**: 「items」をクリックして12件のデータが登録済みであることを確認

#### データ内容確認テスト
- [ ] **商品データ構造**: 各商品にid, name, price, occasion等のフィールドが存在
- [ ] **日本語データ**: 商品名「今治タオル」「静岡茶」等の日本語が正しく格納
- [ ] **検索テスト**: 管理画面の検索ボックスで「タオル」を検索して結果が表示される

#### 検索機能テスト
- [ ] **全文検索**: 「ギフト」で検索すると複数の商品がヒット
- [ ] **部分一致**: 「タ」だけでも「タオル」商品がヒット  
- [ ] **価格検索**: 価格フィルターで3000円以下の商品が絞り込める

### ⚠️ よくある問題とトラブルシューティング（初学者向け詳細版）

> **安心してください**: 以下の問題は初学者でも解決できます。手順通りに進めれば必ず解決します。

#### 🚫 問題1: 「このサイトにアクセスできません」エラー

**😰 症状**: ブラウザで http://localhost:3000 にアクセスすると「このサイトにアクセスできません」

**🔍 原因**: フロントエンドまたはバックエンドサーバーが起動していない

**✅ 解決手順**:
```cmd
# 1. フロントエンドの確認
# frontendフォルダで以下を実行
cd frontend
npm run dev
# ↑ Next.jsサーバーが起動しているか確認

# 2. バックエンドの確認  
# backendフォルダで以下を実行
cd backend
venv\Scripts\activate
python start_server.py
# ↑ FastAPIサーバーが起動しているか確認

# 3. 起動確認
# ブラウザで確認
http://localhost:3000  # フロントエンド
http://localhost:8000/docs  # バックエンド
```

**🎯 成功のサイン**: 
- フロントエンド: `▲ Next.js 15.x.x - Local: http://localhost:3000`
- バックエンド: `INFO: Uvicorn running on http://127.0.0.1:8000`

#### 問題2: 「No module named 'app'」エラー
**原因**: Pythonパスまたは仮想環境の問題
**解決策**:
```bash
# 正しいディレクトリから実行
cd backend
python app/main.py  # uvicornの代替
```

#### 問題3: Node.js実行ポリシーエラー（Windows）
**原因**: PowerShell実行ポリシー
**解決策**:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 問題4: ウイルスソフトによるブロック
**原因**: uvicornがセキュリティソフトでブロックされる
**解決策**: 
```bash
# uvicornの代わりにPython直接実行
cd backend
python app/main.py
```

#### 問題5: Docker起動失敗
**解決策**:
```bash
# Dockerサービス確認
docker --version
docker compose --version

# ポート競合確認
netstat -an | grep 7700
```

#### 🖼️ 問題6: 画像読み込みエラー（Next.js Image）

**😰 症状**: 検索ページで「Invalid src prop on next/image, hostname "picsum.photos" is not configured」エラー

**🔍 原因**: Next.jsのImageコンポーネントで外部画像ホストが許可されていない

**✅ 解決手順**:
```typescript
// frontend/next.config.ts に以下を追加
const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'picsum.photos',
        pathname: '/**',
      },
      {
        protocol: 'https', 
        hostname: 'thumbnail.image.rakuten.co.jp',
        pathname: '/**',
      }
    ],
  },
};
```

**🔄 重要**: 設定変更後はNext.jsサーバーの再起動が必要
```cmd
# frontendフォルダで実行
# Ctrl+C でサーバー停止 → npm run dev で再起動
```

### 🔄 開発時の起動手順（2回目以降）

```bash
# ターミナル1: Meilisearch（必要に応じて）
cd infra && docker compose up -d

# ターミナル2: バックエンド  
cd backend && source ../venv/bin/activate && python app/main.py

# ターミナル3: フロントエンド
cd frontend && pnpm dev
```

### 📦 パッケージ管理

#### Python依存関係更新
```bash
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r backend/requirements.txt
```

#### Node.js依存関係更新
```bash
cd frontend
pnpm install  # または npm install
```

## 環境変数

### 共通
- `MEILI_URL`: http://127.0.0.1:7700
- `MEILI_KEY`: masterKey
- `INDEX_NAME`: items
- `TIMEZONE`: Asia/Tokyo

### フロントエンド
- `NEXT_PUBLIC_API_BASE`: http://localhost:8000

## API エンドポイント

- `GET /search`: ギフト検索
- `GET /items/{id}`: 商品詳細取得

## 対応用途

- 香典返し
- 結婚内祝い
- 出産内祝い

## 価格帯

- ～3,000円
- ～5,000円
- ～10,000円
- 10,000円～

## セキュリティ

### 環境変数管理
- **秘密情報はSecretsで管理**: API キー、パスワード、トークンなどの秘密情報は環境変数で管理し、本番環境ではGitHub SecretsやAWS Systems Manager Parameter Store等の安全な方法で管理してください。
- **環境変数ファイルのコミット禁止**: `.env*` ファイルは `.gitignore` に追加済みです。絶対にコミットしないでください。
- **`.env.example` ファイル**: 必要な環境変数は `.env.example` ファイルで明示しています。
- **認証情報の分離**: 開発環境と本番環境で異なる認証情報を使用してください。

### CORS設定
- 現在は開発用に `http://localhost:3000` を許可
- 本番環境では適切なドメインに制限してください

## 開発ルール

- 秘密鍵のコミット禁止（.envファイルをgitignoreに追加済み）
- Amazonのスクレイピング禁止
- データ更新頻度：1日1回（将来的にGitHub Actions対応予定）
- セキュリティ設定の定期的な見直し

## 💡 開発者向け情報

### 🏗️ FastAPI推奨アーキテクチャ（2025年10月27日リファクタリング完了）

このプロジェクトは**FastAPI推奨のモダンなアーキテクチャ**に移行済みです：

**バックエンド**: 依存関係注入によるクリーンアーキテクチャ
- `api/v1/`: バージョン管理されたHTTPエンドポイント
- `services/`: プロバイダーパターンによるビジネスロジック  
- `core/`: Pydantic Settingsによる設定管理
- `schemas/`: 型安全なデータ構造定義
- `utils/`: 汎用ユーティリティ関数
- `tests/`: 包括的なテストコード

**フロントエンド**: Repository パターンによるデータ取得抽象化
- `repo.ts`: データ取得の統一窓口
- `repo.mock.ts`: 現在のモック実装
- `repo.api.ts`: 将来のAPI実装（未作成）

## 🚀 大量データ対応・スケーラビリティ設計（初学者向け詳細解説）

### 💾 なぜデータベース(DB)が必要になるのか？

現在は **Meilisearch** のみでサンプルデータ12個を管理していますが、将来的に以下のような大量データを扱う予定です：

**📊 予想データ規模**:
- 🛒 **楽天市場**: 約10万点の内祝い商品
- 🛍️ **Amazon**: 約8万点の関連商品  
- 🛒 **Yahoo!ショッピング**: 約5万点の商品
- 📈 **合計**: **約23万点の商品データ**

この規模になると、以下の課題が発生します：

### ⚠️ 大量データ時の課題と解決策

| 課題 | 現在(12個) | 将来(23万点) | 解決策 |
|------|------------|--------------|--------|
| **検索速度** | 瞬時 | 数秒〜タイムアウト | 🔍 Meilisearch + インデックス最適化 |
| **データ更新** | 手動 | 1日数回の自動更新 | 🔄 GitHub Actions + バッチ処理 |
| **メモリ使用量** | 数MB | 数GB | 💾 PostgreSQL + Redis キャッシュ |
| **API応答時間** | 100ms | 3秒以上 | ⚡ CDN + ロードバランサー |
| **同時アクセス** | 1人 | 100人以上 | 🚀 スケールアウト対応 |

### 🗄️ データベース構成の設計（3層アーキテクチャ）

```
🎯 アプリケーション層（変更なし）
├── 🌐 フロントエンド: Next.js (localhost:3000)
└── 🔧 バックエンド: FastAPI (localhost:8000)

💾 データベース層（新規追加）
├── 🗄️ PostgreSQL (localhost:5432)
│   ├── 📊 商品マスタテーブル: 23万件の商品詳細データ
│   ├── 🏪 販売店テーブル: 楽天・Amazon・Yahoo!の店舗情報
│   ├── 📈 価格履歴テーブル: 価格変動の追跡
│   ├── 👤 ユーザーテーブル: お気に入り・検索履歴
│   └── 📊 統計テーブル: アクセス解析・人気商品ランキング
│
├── 📊 Redis (localhost:6379)  
│   ├── 🚀 検索結果キャッシュ: 人気検索ワードの結果を30分保持
│   ├── 🔒 セッション管理: ユーザーの一時的なデータ
│   └── ⚡ API応答キャッシュ: 外部API結果の一時保存
│
└── 🔍 Meilisearch (localhost:7700) - 検索エンジン専用
    ├── 📚 「items」インデックス: 23万件の高速全文検索用
    ├── 📝 検索フィールド: 商品名・説明・カテゴリ・ブランド
    ├── 🏷️ フィルタフィールド: 価格・用途・販売店・評価
    └── 🔤 日本語形態素解析: ひらがな・カタカナ・漢字対応
```

### 🔄 データ同期・更新戦略

#### 📡 外部API → 内部DB への同期フロー
```
🕐 毎日 AM 2:00 (GitHub Actions 自動実行)
    ↓
🤖 data_sync_job.py スクリプト起動
    ↓
📡 外部API呼び出し (並行実行)
├── 🛒 楽天 Items API: 新商品・価格更新を取得
├── 🛍️ Amazon Product API: 商品詳細・レビューを取得  
└── 🛒 Yahoo! API: 在庫状況・セール情報を取得
    ↓
🗄️ PostgreSQL 更新処理
├── 📊 新商品の追加: INSERT INTO products
├── 💰 価格変動の記録: INSERT INTO price_history  
├── 📈 在庫状況の更新: UPDATE products SET stock_status
└── ❌ 廃盤商品の無効化: UPDATE products SET is_active = false
    ↓
🔍 Meilisearch 再インデックス
├── 📚 更新された商品データを反映
├── 🏷️ 新しいフィルタ条件の追加
└── ⚡ インデックス最適化で検索速度向上
    ↓
📊 Redis キャッシュクリア
└── 💾 古いキャッシュを削除して最新データを保証
```

#### 🔄 リアルタイム在庫同期（将来実装）
```
👤 ユーザーが商品詳細を閲覧
    ↓
📡 在庫API呼び出し (キャッシュ優先)
├── 📊 Redis キャッシュをチェック (5分間有効)
├── ❌ キャッシュなし → 楽天API呼び出し
└── ✅ 最新在庫状況をユーザーに表示
```

### ⚡ 高速化・パフォーマンス対策

#### 🚀 フロントエンド高速化
```
🌐 CDN配信 (Cloudflare / AWS CloudFront)
├── 🖼️ 商品画像: 23万点の画像を世界中に配信
├── 📱 レスポンシブ画像: デバイスに合わせた最適サイズ
└── 🗜️ 画像圧縮: WebP形式で70%サイズ削減

⚡ ページ読み込み最適化  
├── 🎯 Server Side Rendering: 初回表示を高速化
├── 🔄 ISR (Incremental Static Regeneration): 人気ページを事前生成
└── 📦 Code Splitting: 必要な部分のみ読み込み
```

#### 🔧 バックエンド高速化
```
🚀 ロードバランサー (nginx)
├── 🔀 複数のFastAPIサーバーに負荷分散  
├── 📊 ヘルスチェック: 障害サーバーを自動除外
└── 🔒 SSL termination: HTTPS通信の高速処理

💾 キャッシュ戦略 (Redis)
├── 🏆 人気商品: 1時間キャッシュ
├── 🔍 検索結果: 30分キャッシュ  
├── 📊 統計データ: 1日キャッシュ
└── 👤 ユーザー設定: 永続化キャッシュ
```

#### 🔍 検索エンジン最適化 (Meilisearch)
```
📚 インデックス設計
├── 🎯 プライマリフィールド: 商品名・説明 (重み 3.0)
├── 📝 セカンダリフィールド: ブランド・カテゴリ (重み 1.5)  
└── 🏷️ フィルタフィールド: 価格・用途・販売店 (重み 1.0)

⚡ 検索パフォーマンス
├── 🔤 日本語形態素解析: MeCab + NEologd辞書
├── 📊 ファセット検索: 価格帯・カテゴリの高速集計
├── 🎯 地理的検索: 配送地域での絞り込み
└── 📈 検索候補: オートコンプリート機能
```

### 📊 監視・運用体制

#### 🔍 システム監視 (Prometheus + Grafana)
```
📈 メトリクス収集
├── 🌐 API応答時間: 平均・95%ile・99%ile
├── 💾 DB接続数: PostgreSQL・Redis接続プール
├── 🔍 検索パフォーマンス: Meilisearch応答時間
├── 📊 エラー率: 4xx・5xxエラーの発生頻度  
└── 👥 同時接続数: アクティブユーザー数

🚨 アラート設定
├── ⏱️ API応答時間 > 2秒: Slack通知
├── 💾 DB接続率 > 80%: メール通知
├── 🔍 検索エラー率 > 5%: 即座にSlack通知
└── 📊 サーバーCPU > 80%: 自動スケーリング実行
```

### 💰 コスト最適化戦略

#### ☁️ インフラコスト (AWS想定)
```
💾 データベース
├── 🗄️ RDS PostgreSQL (t3.medium): 月額 $65
├── 📊 ElastiCache Redis (t3.micro): 月額 $15  
└── 🔍 EC2 Meilisearch (t3.small): 月額 $20

🌐 ネットワーク・配信
├── 🚀 CloudFront CDN: 月額 $30 (画像配信)
├── 🔀 ALB Load Balancer: 月額 $25
└── 📡 API Gateway: 月額 $20 (外部API制御)

📊 監視・バックアップ  
├── 📈 CloudWatch: 月額 $15
└── 💾 S3 バックアップ: 月額 $10
───────────────────────
💰 合計想定コスト: 月額 $200 (約30,000円)
```

### 🎯 段階的移行プラン（3段階で実装）

#### 🚀 フェーズ1: データベース基盤構築 (2週間)
- [ ] PostgreSQL・Redis・Docker環境セットアップ
- [ ] 既存12個のサンプルデータをDBに移行
- [ ] バックエンドのDB接続層実装
- [ ] **フロントエンドは無変更** (同じAPIを継続使用)

#### 📡 フェーズ2: 外部API連携 (4週間) 
- [ ] 楽天API・Amazon API・Yahoo! APIのプロバイダー実装
- [ ] データ同期バッチ処理の作成
- [ ] 23万件データの初回インポート
- [ ] **フロントエンドは無変更** (データが増えるだけ)

#### ⚡ フェーズ3: 高速化・運用最適化 (4週間)
- [ ] Redis キャッシュ層の実装  
- [ ] CDN・ロードバランサーの導入
- [ ] 監視・アラート体制の構築
- [ ] **フロントエンドは無変更** (速度向上のみ体感)

**🎯 移行の利点**: 
- ✅ **ゼロダウンタイム**: フロントエンドを変更せず段階的に移行
- ✅ **リスク最小化**: 各フェーズで動作確認してから次に進行  
- ✅ **学習効果**: 各技術を段階的に習得可能
- ✅ **コスト管理**: 必要に応じてスケールアップ/ダウン可能

### 将来の拡張予定

1. **データソース拡張**
   - 楽天市場API連携（プロバイダー準備済み）
   - Amazon・Yahoo!ショッピング連携
   - 商品データのリアルタイム更新
   - 23万点規模への対応

2. **AI機能追加**  
   - チャットボットによる商品レコメンド（設定準備済み）
   - 自然言語での商品検索
   - 過去履歴からの個人化レコメンド

3. **ユーザー機能**
   - お気に入り商品保存
   - 検索履歴・おすすめ表示
   - 価格変動アラート通知

4. **運用・監視機能**
   - システム監視ダッシュボード
   - 自動スケーリング
   - 障害時の自動復旧

## 📝 FastAPIアーキテクチャ・リファクタリング完了報告（2025年10月27日）

### 🎯 実施した作業内容

#### 1. FastAPI推奨フォルダ構造への完全移行
- ✅ `api/v1/` - バージョン管理されたAPIエンドポイント
- ✅ `core/` - Pydantic Settingsによる設定管理
- ✅ `services/` - プロバイダーパターンによるビジネスロジック
- ✅ `schemas/` - 型安全なPydanticモデル
- ✅ `utils/` - 汎用ユーティリティ関数
- ✅ `tests/` - 包括的なテストコード

#### 2. 現代的な設計パターンの導入
- ✅ **依存関係注入**: FastAPI Dependsによる現代的なDI
- ✅ **プロバイダーパターン**: データソースの抽象化と切り替え
- ✅ **設定管理**: Pydantic Settingsによる型安全な環境変数管理
- ✅ **将来対応**: 楽天API・LLM機能の設定を先行準備

#### 3. 品質保証・テスト環境の整備
- ✅ **pytest**: 単体テスト・統合テストの実装
- ✅ **APIテスト**: 全エンドポイントの動作確認
- ✅ **サービステスト**: ビジネスロジック層のテスト

#### 4. 初心者対応の日本語ドキュメント
- ✅ **詳細コメント**: 各ファイルの役割と責任を説明
- ✅ **設計思想解説**: なぜこの構造にしたかの理由
- ✅ **拡張ガイド**: 将来機能追加時の手順

### 🛠️ 新しい起動手順（FastAPI推奨アーキテクチャ対応）

```cmd
# FastAPIサーバー起動（新アーキテクチャ）
cd backend && python start_server.py
```

### 🎯 動作確認済みエンドポイント

- **🌐 Swagger UI**: http://127.0.0.1:8000/docs  
- **📝 ReDoc**: http://127.0.0.1:8000/redoc
- **🔍 商品検索**: `GET /api/v1/search?query=ギフト`
- **📊 統計情報**: `GET /api/v1/stats/search`
- **💚 ヘルスチェック**: `GET /health`

### 🏆 アーキテクチャの利点

1. **拡張性**: 新しいデータソース（楽天API）の追加が容易
2. **保守性**: 責務が明確に分離され、変更の影響範囲が限定的
3. **テスト容易性**: 依存関係注入によりモック・スタブが簡単
4. **型安全性**: Pydanticによる実行時型チェック
5. **初学者対応**: 豊富な日本語コメントと設計思想の説明

## 📚 整理・リファクタリング完了報告（前回作業・2025年10月27日）

### 実施した作業内容

#### 1. 未使用ファイル・依存の削除
- ✅ `frontend/public/` の未使用SVGファイル5個を削除
- ✅ 重複していた `next.config.js` を削除（TypeScript版を使用）  
- ✅ 重複していた `start_server.py` を削除
- ✅ 冗長な `.env.example` ファイルを統合

#### 2. フォルダ構成の再編
- ✅ `backend/app/` を `routers/`, `services/`, `schemas/` に分割
- ✅ `frontend/src/lib/` に型定義とリポジトリ層を新設
- ✅ 責務の明確な分離によりメンテナンス性を向上

#### 3. 日本語コメントの追加  
- ✅ 全ファイルの先頭に「このファイルの役割」を記載
- ✅ 主要関数にDocstring/JSDocで引数・返り値・処理内容を説明
- ✅ 行内コメントで「なぜこの実装か」を補足

#### 4. 型定義の明確化・共有
- ✅ `frontend/src/lib/types.ts` に統一的な型定義を作成
- ✅ バックエンドのスキーマとフロントエンドの型の整合性を確保
- ✅ 型安全性の向上とIDE支援の強化

#### 5. データ取得口の一本化
- ✅ `repo.ts` でデータ取得を抽象化
- ✅ `repo.mock.ts` で現在のモック実装を提供
- ✅ 将来のAPI切り替えが容易な構造を構築

#### 6. 環境変数設定の充実
- ✅ 開発・本番・将来拡張用の設定テンプレートを作成
- ✅ 各設定項目に詳細な説明コメントを付与
- ✅ セキュリティ設定の注意点を明記

#### 7. README の初学者向け刷新
- ✅ Windows前提の手順を詳細に記載
- ✅ 技術構成の役割を図解で説明
- ✅ データフローの可視化
- ✅ 動作確認項目のチェックリスト化

### 効果・改善点

**🎯 初学者にとって**:
- プロジェクト構造が一目で理解できる
- 各ファイルの役割が明確  
- Windows環境での起動手順が完備

**🛠️ 開発者にとって**:
- 責務が分離され、修正箇所の特定が容易
- 型安全性が向上し、バグの早期発見が可能
- 将来のAPI切り替えが最小変更で実現可能

**🚀 将来の拡張に向けて**:
- 楽天API導入時は `repo.api.ts` を追加するだけ
- AI機能追加時は既存コードへの影響を最小化
- 新機能開発時の学習コストを大幅削減

このリファクタリングにより、**初学者が30分で全体像を把握し、開発に参加できる**状態を実現しました。

## 💡 よくある質問とトラブルシューティング（FAQ）

### 🚨 セットアップ時のよくあるエラー

#### ❌ Q1: 「docker compose up -d」で「docker: command not found」と言われる
**A**: Docker Desktopがインストールされていない、またはDockerが起動していません。

**解決手順**:
```cmd
# 1. Docker Desktopがインストールされているか確認
docker --version

# 2. エラーが出る場合は公式サイトからインストール
# https://www.docker.com/products/docker-desktop/

# 3. インストール後、Docker Desktopを起動
# 4. タスクトレイにDockerのアイコンが表示されることを確認

# 5. 再度実行
docker --version
# → Docker version 20.10.x 以上が表示される
```

#### ❌ Q2: 「python -m venv venv」で「No module named venv」と言われる
**A**: Pythonのバージョンが古い（3.7以下）、またはPythonが正しくインストールされていません。

**解決手順**:
```cmd
# 1. Pythonバージョン確認
python --version
# → Python 3.8.x 以上である必要がある

# 2. 古い場合は公式サイトから最新版をダウンロード
# https://www.python.org/downloads/

# 3. インストール時に「Add Python to PATH」にチェック
# 4. コマンドプロンプトを再起動
# 5. 再度確認
python --version
```

#### ❌ Q3: 仮想環境を有効化しても「(venv)」が表示されない
**A**: 仮想環境の作成に失敗しているか、有効化コマンドが間違っています。

**解決手順**:
```cmd
# 1. 現在のディレクトリを確認
pwd
# プロジェクトルートにいることを確認

# 2. venvフォルダが存在するか確認
dir
# venvフォルダが見えない場合は再作成

# 3. 仮想環境を再作成
rmdir /s venv  # 既存のvenvフォルダを削除（存在する場合）
python -m venv venv

# 4. 正しいパスで有効化
venv\Scripts\activate

# 5. 成功すると以下のような表示になる
# (venv) C:\Users\...\gift_search_app>
```

#### ❌ Q4: 「npm install」で「EACCES」「permission denied」エラー
**A**: Node.jsの権限設定に問題があります。

**解決手順**:
```cmd
# 方法1: 管理者権限でコマンドプロンプトを実行
# Windowsメニューで「cmd」を右クリック→「管理者として実行」

# 方法2: Node.js を再インストール
# 1. コントロールパネルでNode.jsをアンインストール
# 2. 公式サイトから最新版をダウンロード
# 3. インストール時に管理者として実行

# 方法3: npm キャッシュをクリア
npm cache clean --force
npm install
```

### 🐛 実行時のよくあるエラー

#### ❌ Q5: ブラウザで「This site can't be reached」が表示される
**A**: 各サービスが正しく起動していません。以下を順番に確認してください。

**診断手順**:
```cmd
# 1. Meilisearchの確認
docker ps
# STATE が "Up" になっているか確認

# STATUS が "Exited" の場合
docker compose -f infra/docker-compose.yml up -d

# 2. バックエンドの確認
# バックエンドのコマンドプロンプトで以下が表示されているか
# INFO:     Uvicorn running on http://127.0.0.1:8000

# 表示されていない場合は再起動
cd backend
venv\Scripts\activate
python start_server.py

# 3. フロントエンドの確認  
# フロントエンドのコマンドプロンプトで以下が表示されているか
# ▲ Next.js 15.x.x
# - Local:        http://localhost:3000

# 表示されていない場合は再起動
cd frontend
npm run dev
```

#### ❌ Q6: 検索しても「0件の商品が見つかりました」と表示される
**A**: Meilisearchにデータが投入されていません。

**解決手順**:
```cmd
# 1. Meilisearchの管理画面でインデックスを確認
# ブラウザで http://localhost:7700 にアクセス
# "items" インデックスがあり、2070件のドキュメントが存在するか確認

# 2. データが0件または存在しない場合は再投入
cd scripts
python index_meili.py

# 3. 成功メッセージを確認
# Successfully indexed 2070 items to Meilisearch

# 4. 再度 http://localhost:7700 でデータ件数を確認
```

#### ❌ Q7: 「ModuleNotFoundError: No module named 'fastapi'」エラー
**A**: 仮想環境が有効化されていないか、パッケージがインストールされていません。

**解決手順**:
```cmd
# 1. 仮想環境が有効化されているか確認
# プロンプトに (venv) が表示されているか確認

# 2. 表示されていない場合は有効化
venv\Scripts\activate

# 3. パッケージを再インストール
pip install -r backend\requirements.txt

# 4. インストールされているかパッケージ確認
pip list
# fastapi、uvicorn、meilisearch等が表示されることを確認
```

### ⚙️ 設定・カスタマイズに関する質問

#### ❓ Q8: Meilisearchの管理画面にアクセスできない
**A**: Meilisearchが正しく起動していないか、ポートが使用中です。

**確認手順**:
```cmd
# 1. Dockerコンテナの状態確認
docker ps -a
# meilisearch のコンテナが "Up" になっているか

# 2. "Exited" の場合はログを確認
docker logs gift-search-meilisearch-1

# 3. ポート7700が使用中の場合
netstat -an | findstr :7700
# 他のプロセスが使用している場合はプロセスを終了

# 4. Meilisearchを再起動
docker compose -f infra/docker-compose.yml down
docker compose -f infra/docker-compose.yml up -d
```

#### ❓ Q9: 別のポート番号で起動したい場合は？
**A**: 各設定ファイルでポート番号を変更できます。

**変更手順**:
```cmd
# バックエンドのポート変更（8000→8001）
# backend/start_server.py の port=8000 を port=8001 に変更

# フロントエンドのポート変更（3000→3001）  
# frontend/package.json の "dev": "next dev" を "dev": "next dev -p 3001" に変更

# Meilisearchのポート変更（7700→7701）
# infra/docker-compose.yml の "7700:7700" を "7701:7700" に変更
```

#### ❓ Q10: 本番環境にデプロイするには？
**A**: 現在は開発環境用の設定です。本番環境では以下の変更が必要です。

**本番環境準備**:
```cmd
# 1. 環境変数の設定
# .env ファイルで ENVIRONMENT=production に設定

# 2. フロントエンドのビルド
cd frontend
npm run build
npm start  # 本番サーバー起動

# 3. バックエンドの本番起動
cd backend  
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 4. セキュリティ設定
# - HTTPS化
# - CORS設定の厳格化
# - APIキーの設定
```

### 🔧 開発・カスタマイズに関する質問

#### ❓ Q11: 新しい商品データを追加するには？
**A**: `scripts/data/sample_items.json` を編集後、再投入します。

**手順**:
```cmd
# 1. データファイルを編集
# scripts/data/sample_items.json に新しい商品を追加

# 2. データを再投入
cd scripts
python index_meili.py

# 3. Meilisearchで確認
# http://localhost:7700 で件数が増加していることを確認
```

#### ❓ Q12: 検索条件を追加するには？
**A**: フロントエンドとバックエンド両方の修正が必要です。

**変更箇所**:
```typescript
// frontend/src/components/SearchControls.tsx
// 新しいフィルタボタンを追加

// frontend/src/lib/api.ts  
// APIリクエストに新しいパラメータを追加

// backend/app/schemas.py
// 新しいフィルタパラメータを追加

// backend/app/services/search_service_fixed.py
// フィルタ処理を追加
```

#### ❓ Q13: UIデザインを変更するには？
**A**: Tailwind CSSクラスを編集することでデザインを変更できます。

**変更例**:
```tsx
// frontend/src/components/ProductCard.tsx
// className の値を変更してデザイン調整

// 色の変更例
bg-blue-500 → bg-green-500  // 背景色を青から緑に
text-gray-600 → text-red-600  // 文字色をグレーから赤に
```

## 📞 サポート・問い合わせ

### 🆘 問題が解決しない場合

1. **エラーメッセージを記録**: 正確なエラーメッセージをコピーしてください
2. **環境情報を確認**: OS、Python・Node.js・Dockerのバージョンを確認
3. **ログを確認**: 各サービスのコマンドプロンプトに表示されるログを確認
4. **公式ドキュメント**: [Meilisearch](https://docs.meilisearch.com/)、[FastAPI](https://fastapi.tiangolo.com/)、[Next.js](https://nextjs.org/docs) の公式ドキュメントを参照

### 📚 学習リソース

- **Meilisearch入門**: [公式チュートリアル](https://docs.meilisearch.com/learn/getting_started/quick_start.html)
- **FastAPI学習**: [公式チュートリアル](https://fastapi.tiangolo.com/tutorial/)
- **Next.js学習**: [公式ラーニングコース](https://nextjs.org/learn)
- **React基礎**: [公式チュートリアル](https://react.dev/learn)

## ライセンス

MIT License